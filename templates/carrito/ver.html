{% extends "base.html" %}
{% block content %}
<h2 class="mb-4 text-white">ðŸ›’ Mi Carrito</h2>


{% if items %}
<form action="{{ url_for('carrito.actualizar_carrito') }}" method="post">
  
  <div class="table-responsive shadow rounded">
    <table class="table table-dark table-hover align-middle mb-0">
      <thead class="text-white border-bottom border-secondary fw-bold text-uppercase small" style="letter-spacing: 1px;">
        <tr>
          <th>Producto</th>
          <th style="width:140px;" class="text-center">Cantidad</th>
          <th class="text-end">Precio</th>
          <th class="text-end">Subtotal</th>
          <th class="text-center" style="width: 100px;">Acciones</th>
        </tr>
      </thead>

      <tbody>
      {% set ns = namespace(total=0) %}
      
      {% for item in items %}
        {% set producto = Producto.query.get(item.producto_id) %}
        {% set subtotal = producto.precio * item.cantidad %}
        {% set ns.total = ns.total + subtotal %}

        <tr>
          <td>
            <!-- IMPORTANTE AREGLAR -->
            <div class="d-flex align-items-center">

                <div>
                    <strong class="text-white d-block" style="font-size: 1.1rem;">{{ producto.nombre }}</strong>
                    <small class="text-white-50">{{ producto.descripcion[:50] }}...</small>
                </div>
            </div>
          </td>

          <td>
            <input type="number"
                   min="1"
                   max="{{ producto.stock }}"
                   name="qty_{{ item.id }}"
                   value="{{ item.cantidad }}"
                   class="form-control form-control-sm text-center bg-dark text-white border-secondary mx-auto"
                   style="width: 80px;">
            <div class="text-center mt-1">
                <small class="text-white-50" style="font-size: 0.7rem;">Stock: {{ producto.stock }}</small>
            </div>
          </td>

          <td class="text-end fw-semibold text-white fs-5">
              ${{ '%.2f'|format(producto.precio) }}
          </td>
          
          <td class="text-end fw-bold text-white fs-5">
              ${{ '%.2f'|format(subtotal) }}
          </td>

          <td class="text-center">
            <button type="submit" 
               formaction="{{ url_for('carrito.eliminar_item', item_id=item.id) }}"
               class="btn btn-sm btn-outline-danger border-0"
               title="Eliminar del carrito">
               <i class="bi bi-trash-fill fs-5"></i>
            </button>
          </td>
        </tr>

      {% endfor %}
      </tbody>

      <tfoot class="bg-dark border-top border-secondary">
        <tr>
          <td colspan="3" class="text-end text-white-50 pe-3 align-middle">Total a Pagar:</td>
          <td class="text-end fw-bold text-success display-6 align-middle">
              ${{ '%.2f'|format(ns.total) }}
          </td>
          <td></td>
        </tr>
      </tfoot>
    </table>
  </div>

  <div class="d-flex justify-content-between align-items-center mt-4 flex-wrap gap-3">
    <div class="d-flex gap-3">
        <button class="btn btn-outline-secondary text-white d-flex align-items-center gap-2">
            <i class="bi bi-arrow-clockwise"></i> Actualizar
        </button>

        <a href="{{ url_for('carrito.vaciar_carrito') }}" 
           class="btn btn-outline-danger px-4 d-flex align-items-center justify-content-center gap-2">
            <i class="bi bi-trash"></i> Vaciar Carrito
        </a>
    </div>
  </div>
</form>

<!-- SECCIÃ“N DE ACCIONES DE COMPRA (Dos Botones) -->
<div class="d-flex justify-content-end mt-4 pt-2 border-top border-secondary">
    <div style="min-width: 350px;">
        <form action="{{ url_for('pedidos.confirmar_pedido') }}" method="post" class="d-grid gap-3">
            
            <!-- OPCIÃ“N 1: Pagar Ahora (Verde) -->
            <button type="submit" name="accion" value="pagar" 
                    class="btn btn-success w-100 py-3 fs-5 fw-bold shadow-lg d-flex align-items-center justify-content-center gap-2">
                <i class="bi bi-credit-card-2-front-fill"></i> Pagar Ahora
            </button>

            <!-- OPCIÃ“N 2: Confirmar y Pagar DespuÃ©s (Azul) -->
            <button type="submit" name="accion" value="confirmar" 
                    class="btn btn-outline-primary w-100 py-2 fw-semibold d-flex align-items-center justify-content-center gap-2">
                <i class="bi bi-clock-history"></i> Solo Confirmar (Pagar despuÃ©s)
            </button>
            
        </form>
    </div>
</div>

{% else %}
<div class="text-center py-5">
    <i class="bi bi-cart-x display-1 text-muted"></i>
    <h3 class="mt-3 text-white">Tu carrito estÃ¡ vacÃ­o.</h3>
    <a href="{{ url_for('productos.listar_productos') }}" class="btn btn-primary mt-3">Ir a comprar</a>
</div>
{% endif %}
{% endblock %}
